<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>URL管理＆整理くん</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
body {
  margin: 0;
  background: #bfe9ff; /* 枠外 水色 */
  font-family: sans-serif;
}

.container {
  max-width: 800px;
  margin: 20px auto;
  background: white;
  padding: 20px;
  border-radius: 10px;
}

input, textarea, button {
  width: 100%;
  padding: 8px;
  margin: 4px 0;
}

button {
  cursor: pointer;
}

.entry {
  border: 1px solid #ccc;
  padding: 10px;
  margin-top: 10px;
}

.small {
  font-size: 12px;
  color: #555;
}
</style>
</head>

<body>

<div class="container">
  <h1>URL管理＆整理くん</h1>
  <p id="user">未ログイン</p>
  <p id="counter">閲覧者数: --</p>

  <button onclick="login()">Googleでログイン</button>
  <button onclick="logout()">ログアウト</button>

  <hr>

  <h3>追加</h3>
  <input id="url" placeholder="URL">
  <input id="genre" placeholder="ジャンル">
  <textarea id="memo" placeholder="メモ"></textarea>
  <button onclick="addEntry()">追加</button>

  <hr>

  <h3>検索</h3>
  <input id="searchGenre" placeholder="ジャンル検索">
  <input id="searchDate" type="date">
  <button onclick="search()">検索</button>
  <button onclick="loadData()">クリア</button>

  <hr>

  <div id="list"></div>
</div>

<script>
/* Firebase設定 */
const firebaseConfig = {
  apiKey: "AIzaSyCRbxQK7LFzoEAeTYhFVrPEGCJx9QU7hAQ",
  authDomain: "url-kanri-kun.firebaseapp.com",
  projectId: "url-kanri-kun"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let uid = null;
let allData = [];

/* ログイン */
function login() {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider);
}

/* ログアウト */
function logout() {
  auth.signOut();
}

/* 認証状態 */
auth.onAuthStateChanged(async user => {
  if (!user) {
    uid = null;
    document.getElementById("user").innerText = "未ログイン";
    document.getElementById("list").innerHTML = "";
    return;
  }

  uid = user.uid;
  document.getElementById("user").innerText =
    `ログイン中：${user.displayName}`;

  await countVisitor();
  loadData();
});

/* 閲覧者カウンター */
async function countVisitor() {
  const ref = db.collection("meta").doc("counter");
  await db.runTransaction(async tx => {
    const doc = await tx.get(ref);
    const count = doc.exists ? doc.data().count + 1 : 1;
    tx.set(ref, { count });
    document.getElementById("counter").innerText =
      `閲覧者数: ${count}`;
  });
}

/* 追加 */
async function addEntry() {
  if (!uid) return;

  const url = url.value;
  if (!url) return;

  await db.collection("users")
    .doc(uid)
    .collection("urls")
    .add({
      url,
      genre: genre.value,
      memo: memo.value,
      created: firebase.firestore.Timestamp.now()
    });

  url.value = genre.value = memo.value = "";
  loadData();
}

/* 読み込み */
async function loadData() {
  if (!uid) return;

  const snap = await db.collection("users")
    .doc(uid)
    .collection("urls")
    .orderBy("created", "desc")
    .get();

  allData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  render(allData);
}

/* 描画 */
function render(list) {
  const div = document.getElementById("list");
  div.innerHTML = "";

  list.forEach(e => {
    const date = e.created.toDate();
    div.innerHTML += `
      <div class="entry">
        <a href="${e.url}" target="_blank">${e.url}</a>
        <div>ジャンル：${e.genre}</div>
        <div>メモ：${e.memo}</div>
        <div class="small">
          ${date.toLocaleDateString()} ${date.toLocaleTimeString()}
        </div>
        <button onclick="removeEntry('${e.id}')">削除</button>
      </div>
    `;
  });
}

/* 削除 */
async function removeEntry(id) {
  await db.collection("users")
    .doc(uid)
    .collection("urls")
    .doc(id)
    .delete();

  loadData();
}

/* 検索 */
function search() {
  const g = searchGenre.value;
  const d = searchDate.value;

  const filtered = allData.filter(e => {
    const date = e.created.toDate().toISOString().slice(0,10);
    return (!g || e.genre.includes(g)) &&
           (!d || date === d);
  });

  render(filtered);
}
</script>

</body>
</html>
