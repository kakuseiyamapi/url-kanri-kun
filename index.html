<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>URL管理くん（実用版）</title>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
body { font-family: sans-serif; margin: 20px; }
input, textarea, button { width: 100%; margin: 4px 0; padding: 6px; }
.entry { border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
.small { font-size: 12px; color: #666; }
</style>
</head>

<body>

<h2>URL管理くん（Firestore実用版）</h2>

<button onclick="login()">Googleでログイン</button>
<button onclick="logout()">ログアウト</button>
<p id="user"></p>

<hr>

<input id="url" placeholder="URL">
<input id="genre" placeholder="ジャンル">
<textarea id="memo" placeholder="メモ"></textarea>
<button onclick="addEntry()">追加</button>

<hr>
<div id="list"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCRbxQK7LFzoEAeTYhFVrPEGCJx9QU7hAQ",
  authDomain: "url-kanri-kun.firebaseapp.com",
  projectId: "url-kanri-kun",
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
let currentUser = null;

// ログイン
function login() {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider);
}

// ログアウト
function logout() {
  auth.signOut();
  document.getElementById("list").innerHTML = "";
  document.getElementById("user").innerText = "";
}

// 認証監視
auth.onAuthStateChanged(user => {
  if (user) {
    currentUser = user;
    document.getElementById("user").innerText =
      "ログイン中：" + user.displayName;
    loadData();
  } else {
    currentUser = null;
  }
});

// 追加
function addEntry() {
  if (!currentUser) return alert("ログインして");

  db.collection("users")
    .doc(currentUser.uid)
    .collection("urls")
    .add({
      url: url.value,
      genre: genre.value,
      memo: memo.value,
      created: firebase.firestore.FieldValue.serverTimestamp()
    });

  url.value = genre.value = memo.value = "";
}

// 読み込み
function loadData() {
  db.collection("users")
    .doc(currentUser.uid)
    .collection("urls")
    .orderBy("created", "desc")
    .onSnapshot(snapshot => {
      list.innerHTML = "";
      snapshot.forEach(doc => {
        const e = doc.data();
        list.innerHTML += `
          <div class="entry">
            <a href="${e.url}" target="_blank">${e.url}</a>
            <div>ジャンル：${e.genre}</div>
            <div>メモ：${e.memo}</div>
            <button onclick="removeEntry('${doc.id}')">削除</button>
          </div>
        `;
      });
    });
}

// 削除
function removeEntry(id) {
  db.collection("users")
    .doc(currentUser.uid)
    .collection("urls")
    .doc(id)
    .delete();
}
</script>

</body>
</html>
