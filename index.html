<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>URL管理＆整理くん</title>

<style>
body {
  font-family: sans-serif;
  background: #bfe7ff;
  margin: 0;
  padding: 20px;
}

.container {
  background: #fff;
  max-width: 700px;
  margin: auto;
  padding: 20px;
  border-radius: 10px;
}

input, textarea, button {
  width: 100%;
  margin: 5px 0;
  padding: 8px;
}

.entry {
  border: 1px solid #ccc;
  padding: 10px;
  margin-top: 10px;
}

.small {
  font-size: 12px;
  color: #666;
}
</style>
</head>

<body>

<div class="container">
<h1>URL管理＆整理くん</h1>

<p id="counter"></p>
<button onclick="login()">Googleでログイン</button>
<p id="user"></p>

<hr>

<h3>追加</h3>
<input id="url" placeholder="URL">
<input id="genre" placeholder="ジャンル">
<textarea id="memo" placeholder="メモ"></textarea>
<button onclick="addEntry()">追加</button>

<hr>

<h3>検索</h3>
<input id="searchGenre" placeholder="ジャンル検索">
<input id="searchDate" type="date">
<button onclick="search()">検索</button>
<button onclick="clearSearch()">クリア</button>

<hr>
<div id="list"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCRbxQK7LFzoEAeTYhFVrPEGCJx9QU7hAQ",
  authDomain: "url-kanri-kun.firebaseapp.com",
  projectId: "url-kanri-kun",
  storageBucket: "url-kanri-kun.appspot.com",
  messagingSenderId: "142130647668",
  appId: "1:142130647668:web:a24da9ae06dfa84ad37721"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;
let allData = [];

/* ページ表示ごとにカウント */
const counterRef = db.collection("meta").doc("counter");
counterRef.set({count:0},{merge:true}).then(()=>{
  counterRef.update({count: firebase.firestore.FieldValue.increment(1)});
});
counterRef.onSnapshot(doc=>{
  document.getElementById("counter").innerText =
    "あなたは " + doc.data().count + " 人目のユーザーです";
});

/* ログイン */
function login() {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider);
}

auth.onAuthStateChanged(user => {
  if (!user) return;
  currentUser = user;
  document.getElementById("user").innerText =
    "ログイン中：" + user.displayName;
  loadData();
});

/* 追加 */
function addEntry() {
  if (!currentUser) return alert("ログインして");
  const url = url.value;
  if (!url) return;

  const now = new Date();
  db.collection("users").doc(currentUser.uid)
    .collection("urls").add({
      url,
      genre: genre.value,
      memo: memo.value,
      date: now.toISOString().slice(0,10),
      time: now.toLocaleTimeString(),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

  document.getElementById("url").value="";
  document.getElementById("genre").value="";
  document.getElementById("memo").value="";
}

/* 読み込み */
function loadData() {
  db.collection("users").doc(currentUser.uid)
    .collection("urls")
    .orderBy("createdAt","desc")
    .onSnapshot(snap=>{
      allData = [];
      snap.forEach(d=>allData.push(d.data()));
      render(allData);
    });
}

/* 表示 */
function render(list) {
  const div = document.getElementById("list");
  div.innerHTML="";
  list.forEach(e=>{
    div.innerHTML+=`
      <div class="entry">
        <a href="${e.url}" target="_blank">${e.url}</a>
        <div>ジャンル：${e.genre}</div>
        <div>メモ：${e.memo}</div>
        <div class="small">${e.date} ${e.time}</div>
      </div>`;
  });
}

/* 検索 */
function search() {
  const g = searchGenre.value;
  const d = searchDate.value;
  render(allData.filter(e =>
    (!g || e.genre.includes(g)) &&
    (!d || e.date === d)
  ));
}

function clearSearch() {
  searchGenre.value="";
  searchDate.value="";
  render(allData);
}
</script>

</body>
</html>
