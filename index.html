<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>URL管理くん（実用版）</title>
<style>
body { font-family: sans-serif; margin:20px }
input, textarea, button { width:100%; margin:4px 0; padding:6px }
.entry { border:1px solid #ccc; padding:10px; margin-top:10px }
.small { font-size:12px; color:#555 }
</style>
</head>
<body>

<h1>URL管理くん</h1>

<button onclick="login()">Googleログイン</button>
<button onclick="logout()">ログアウト</button>
<p id="user"></p>

<hr>

<h3>追加</h3>
<input id="url" placeholder="URL">
<input id="genre" placeholder="ジャンル">
<textarea id="memo" placeholder="メモ"></textarea>
<button onclick="addEntry()">追加</button>

<hr>

<h3>検索</h3>
<input id="searchGenre" placeholder="ジャンルで検索">
<button onclick="search()">検索</button>
<button onclick="loadData()">クリア</button>

<div id="list"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  GoogleAuthProvider,
  signInWithPopup,
  signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  deleteDoc,
  doc,
  query,
  where,
  orderBy,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCRbxQK7LFzoEAeTYhFVrPEGCJx9QU7hAQ",
  authDomain: "url-kanri-kun.firebaseapp.com",
  projectId: "url-kanri-kun",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;

/* ---------- 認証 ---------- */
window.login = async () => {
  const provider = new GoogleAuthProvider();
  await signInWithPopup(auth, provider);
};

window.logout = async () => {
  await signOut(auth);
};

onAuthStateChanged(auth, user => {
  if (user) {
    currentUser = user;
    document.getElementById("user").innerText =
      "ログイン中：" + user.displayName;
    loadData();
  } else {
    currentUser = null;
    document.getElementById("user").innerText = "";
    document.getElementById("list").innerHTML = "";
  }
});

/* ---------- データ操作 ---------- */
window.addEntry = async () => {
  if (!currentUser) return alert("ログインして");

  await addDoc(
    collection(db, "users", currentUser.uid, "urls"),
    {
      url: url.value,
      genre: genre.value,
      memo: memo.value,
      createdAt: serverTimestamp()
    }
  );

  url.value = genre.value = memo.value = "";
  loadData();
};

async function loadData() {
  if (!currentUser) return;

  const q = query(
    collection(db, "users", currentUser.uid, "urls"),
    orderBy("createdAt", "desc")
  );

  const snap = await getDocs(q);
  render(snap.docs);
}

window.search = async () => {
  const g = searchGenre.value;
  const q = query(
    collection(db, "users", currentUser.uid, "urls"),
    where("genre", "==", g)
  );
  const snap = await getDocs(q);
  render(snap.docs);
};

function render(docs) {
  list.innerHTML = "";
  docs.forEach(d => {
    const e = d.data();
    list.innerHTML += `
      <div class="entry">
        <a href="${e.url}" target="_blank">${e.url}</a>
        <div>ジャンル：${e.genre}</div>
        <div>メモ：${e.memo}</div>
        <button onclick="del('${d.id}')">削除</button>
      </div>
    `;
  });
}

window.del = async id => {
  await deleteDoc(doc(db, "users", currentUser.uid, "urls", id));
  loadData();
};
</script>

</body>
</html>
