<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>URL管理＆整理くん</title>

<style>
body {
  font-family: sans-serif;
  background: #bfe9f9;
  padding: 20px;
}
.container {
  background: white;
  padding: 20px;
  border-radius: 10px;
  max-width: 800px;
  margin: auto;
}
input, textarea, button {
  width: 100%;
  margin: 6px 0;
  padding: 8px;
}
.entry {
  border: 1px solid #ccc;
  padding: 10px;
  margin-top: 10px;
}
.small {
  font-size: 12px;
  color: #555;
}
</style>
</head>

<body>
<div class="container">

<h1>URL管理＆整理くん</h1>
<p id="counter">あなたは -- 人目のユーザーです</p>

<button onclick="login()">Googleでログイン</button>
<button onclick="logout()">ログアウト</button>
<p id="user"></p>

<hr>

<h3>追加</h3>
<input id="urlInput" placeholder="URL">
<input id="genreInput" placeholder="ジャンル">
<textarea id="memoInput" placeholder="メモ"></textarea>
<button onclick="addEntry()">追加</button>

<hr>

<h3>検索</h3>
<input id="searchGenre" placeholder="ジャンル検索">
<input id="searchDate" type="date">
<button onclick="search()">検索</button>
<button onclick="loadEntries()">クリア</button>

<hr>

<div id="list"></div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCRbxQK7LFzoEAeTYhFVrPEGCJx9QU7hAQ",
  authDomain: "url-kanri-kun.firebaseapp.com",
  projectId: "url-kanri-kun",
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

let currentUid = null;
let entries = [];

/* ===== ユーザーカウント（ページを開いたら＋1）===== */
(async () => {
  const ref = db.collection("meta").doc("counter");
  await db.runTransaction(async tx => {
    const doc = await tx.get(ref);
    const count = doc.exists ? doc.data().count + 1 : 1;
    tx.set(ref, { count });
    document.getElementById("counter").innerText =
      `あなたは ${count} 人目のユーザーです`;
  });
})();

/* ===== 認証 ===== */
function login() {
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
}

function logout() {
  auth.signOut();
  document.getElementById("list").innerHTML = "";
}

auth.onAuthStateChanged(user => {
  if (!user) return;
  currentUid = user.uid;
  document.getElementById("user").innerText =
    "ログイン中：" + user.displayName;
  loadEntries();
});

/* ===== 追加 ===== */
async function addEntry() {
  if (!currentUid) return alert("ログインして");

  const urlValue = document.getElementById("urlInput").value;
  const genreValue = document.getElementById("genreInput").value;
  const memoValue = document.getElementById("memoInput").value;
  if (!urlValue) return;

  const now = new Date();

  await db
    .collection("users")
    .doc(currentUid)
    .collection("urls")
    .add({
      url: urlValue,
      genre: genreValue,
      memo: memoValue,
      date: now.toISOString().slice(0, 10),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

  document.getElementById("urlInput").value = "";
  document.getElementById("genreInput").value = "";
  document.getElementById("memoInput").value = "";

  loadEntries();
}

/* ===== 読み込み ===== */
async function loadEntries() {
  if (!currentUid) return;
  const snap = await db
    .collection("users")
    .doc(currentUid)
    .collection("urls")
    .orderBy("createdAt", "desc")
    .get();

  entries = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  render(entries);
}

/* ===== 描画 ===== */
function render(list) {
  const div = document.getElementById("list");
  div.innerHTML = "";
  list.forEach(e => {
    div.innerHTML += `
      <div class="entry">
        <a href="${e.url}" target="_blank">${e.url}</a>
        <div>ジャンル：${e.genre}</div>
        <div>メモ：${e.memo}</div>
        <div class="small">${e.date}</div>
        <button onclick="removeEntry('${e.id}')">削除</button>
      </div>`;
  });
}

/* ===== 削除 ===== */
async function removeEntry(id) {
  await db
    .collection("users")
    .doc(currentUid)
    .collection("urls")
    .doc(id)
    .delete();
  loadEntries();
}

/* ===== 検索 ===== */
function search() {
  const g = document.getElementById("searchGenre").value;
  const d = document.getElementById("searchDate").value;
  render(entries.filter(e =>
    (!g || e.genre.includes(g)) &&
    (!d || e.date === d)
  ));
}
</script>
</body>
</html>

