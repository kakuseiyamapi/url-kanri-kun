<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>URLç®¡ç†ï¼†æ•´ç†ãã‚“</title>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
body {
  font-family: sans-serif;
  background: #cceeff;
  margin: 0;
}
.container {
  background: white;
  margin: 20px auto;
  padding: 20px;
  max-width: 800px;
  border-radius: 8px;
}
.entry {
  border: 1px solid #ccc;
  padding: 10px;
  margin-top: 10px;
}
.small {
  font-size: 12px;
  color: #555;
}
button {
  margin-top: 5px;
}
</style>
</head>

<body>
<div class="container">
<h1>URLç®¡ç†ï¼†æ•´ç†ãã‚“</h1>

<p id="counter">èª­ã¿è¾¼ã¿ä¸­...</p>

<button onclick="login()">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
<button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
<p id="user"></p>

<hr>

<h3>è¿½åŠ </h3>
<input id="url" placeholder="URL"><br>
<input id="genre" placeholder="ã‚¸ãƒ£ãƒ³ãƒ«"><br>
<textarea id="memo" placeholder="ãƒ¡ãƒ¢"></textarea><br>
<button onclick="addEntry()">è¿½åŠ </button>

<hr>

<h3>æ¤œç´¢</h3>
<input id="searchGenre" placeholder="ã‚¸ãƒ£ãƒ³ãƒ«">
<input id="searchDate" type="date">
<button onclick="search()">æ¤œç´¢</button>
<button onclick="clearSearch()">ã‚¯ãƒªã‚¢</button>

<hr>

<div id="list"></div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCRbxQK7LFzoEAeTYhFVrPEGCJx9QU7hAQ",
  authDomain: "url-kanri-kun.firebaseapp.com",
  projectId: "url-kanri-kun",
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUid = null;
let allData = [];

/* ğŸ”¢ ã‚«ã‚¦ãƒ³ãƒˆï¼ˆãƒšãƒ¼ã‚¸è¡¨ç¤ºã§+1ï¼‰ */
(async () => {
  const ref = db.collection("counters").doc("visitors");
  await db.runTransaction(async tx => {
    const doc = await tx.get(ref);
    const count = doc.exists ? doc.data().count + 1 : 1;
    tx.set(ref, { count });
    document.getElementById("counter").innerText =
      `ã‚ãªãŸã¯ ${count} äººç›®ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã™`;
  });
})();

/* ğŸ” èªè¨¼ */
function login() {
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
}
function logout() {
  auth.signOut();
  document.getElementById("list").innerHTML = "";
  document.getElementById("user").innerText = "";
}

auth.onAuthStateChanged(user => {
  if (!user) return;
  currentUid = user.uid;
  document.getElementById("user").innerText =
    "ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š" + user.displayName;
  loadData();
});

/* ğŸ“¥ èª­ã¿è¾¼ã¿ */
async function loadData() {
  const snap = await db
    .collection("users")
    .doc(currentUid)
    .collection("urls")
    .orderBy("createdAt", "desc")
    .get();

  allData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  render(allData);
}

/* â• è¿½åŠ  */
async function addEntry() {
  if (!currentUid) return alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦");

  const url = url.value;
  if (!url) return;

  await db.collection("users")
    .doc(currentUid)
    .collection("urls")
    .add({
      url,
      genre: genre.value,
      memo: memo.value,
      date: new Date().toISOString().slice(0,10),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

  url.value = genre.value = memo.value = "";
  loadData();
}

/* ğŸ—‘ å‰Šé™¤ */
async function removeEntry(id) {
  await db.collection("users")
    .doc(currentUid)
    .collection("urls")
    .doc(id)
    .delete();
  loadData();
}

/* ğŸ” æ¤œç´¢ */
function search() {
  const g = searchGenre.value;
  const d = searchDate.value;
  render(allData.filter(e =>
    (!g || e.genre.includes(g)) &&
    (!d || e.date === d)
  ));
}

function clearSearch() {
  searchGenre.value = "";
  searchDate.value = "";
  render(allData);
}

/* ğŸ–¨ è¡¨ç¤º */
function render(list) {
  list.innerHTML = "";
  const div = document.getElementById("list");
  div.innerHTML = "";
  list.forEach(e => {
    div.innerHTML += `
      <div class="entry">
        <a href="${e.url}" target="_blank">${e.url}</a>
        <div>ã‚¸ãƒ£ãƒ³ãƒ«ï¼š${e.genre}</div>
        <div>ãƒ¡ãƒ¢ï¼š${e.memo}</div>
        <div class="small">${e.date}</div>
        <button onclick="removeEntry('${e.id}')">å‰Šé™¤</button>
      </div>
    `;
  });
}
</script>
</body>
</html>
