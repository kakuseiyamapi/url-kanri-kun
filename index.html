<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>URL管理＆整理くん</title>

<style>
body {
  font-family: sans-serif;
  background: #cfefff;
  margin: 0;
}

.container {
  background: #fff;
  max-width: 900px;
  margin: 20px auto;
  padding: 20px;
  border-radius: 10px;
}

input, textarea, button {
  width: 100%;
  padding: 8px;
  margin: 5px 0;
}

button {
  cursor: pointer;
}

.entry {
  border: 1px solid #ccc;
  padding: 10px;
  margin-top: 10px;
}
.small {
  font-size: 12px;
  color: #555;
}
</style>
</head>

<body>
<div class="container">

<h1>URL管理＆整理くん</h1>
<p id="counter"></p>

<button onclick="login()">Googleでログイン</button>
<button onclick="logout()">ログアウト</button>
<p id="user"></p>

<hr>

<h3>追加</h3>
<input id="url" placeholder="URL">
<input id="genre" placeholder="ジャンル">
<textarea id="memo" placeholder="メモ"></textarea>
<button onclick="addEntry()">追加</button>

<hr>

<h3>検索</h3>
<input id="searchGenre" placeholder="ジャンル検索">
<input id="searchDate" type="date">
<button onclick="search()">検索</button>
<button onclick="loadData()">クリア</button>

<hr>

<div id="list"></div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCRbxQK7LFzoEAeTYhFVrPEGCJx9QU7hAQ",
  authDomain: "url-kanri-kun.firebaseapp.com",
  projectId: "url-kanri-kun"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
let currentUser = null;

/* ---------- 認証 ---------- */
function login() {
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
}
function logout() {
  auth.signOut();
}

auth.onAuthStateChanged(async user => {
  if (!user) {
    document.getElementById("user").innerText = "未ログイン";
    return;
  }

  currentUser = user;
  document.getElementById("user").innerText =
    "ログイン中：" + user.displayName;

  await countUser();
  loadData();
});

/* ---------- ユーザーカウント ---------- */
async function countUser() {
  const ref = db.collection("counter").doc("global");
  await db.runTransaction(async t => {
    const doc = await t.get(ref);
    const now = doc.exists ? doc.data().count + 1 : 1;
    t.set(ref, { count: now });
    document.getElementById("counter").innerText =
      `あなたは ${now} 人目のユーザーです`;
  });
}

/* ---------- 追加 ---------- */
async function addEntry() {
  if (!currentUser) return alert("ログインして");

  const url = url.value;
  if (!url) return;

  await db
    .collection("users")
    .doc(currentUser.uid)
    .collection("urls")
    .add({
      url,
      genre: genre.value,
      memo: memo.value,
      createdAt: firebase.firestore.Timestamp.now()
    });

  url.value = genre.value = memo.value = "";
  loadData();
}

/* ---------- 読み込み ---------- */
async function loadData() {
  if (!currentUser) return;

  const snap = await db
    .collection("users")
    .doc(currentUser.uid)
    .collection("urls")
    .orderBy("createdAt", "desc")
    .get();

  render(snap.docs.map(d => ({ id: d.id, ...d.data() })));
}

/* ---------- 検索 ---------- */
async function search() {
  let ref = db
    .collection("users")
    .doc(currentUser.uid)
    .collection("urls");

  if (searchGenre.value)
    ref = ref.where("genre", "==", searchGenre.value);

  const snap = await ref.get();
  const filtered = snap.docs
    .map(d => ({ id: d.id, ...d.data() }))
    .filter(d => {
      if (!searchDate.value) return true;
      const d0 = d.createdAt.toDate().toISOString().slice(0,10);
      return d0 === searchDate.value;
    });

  render(filtered);
}

/* ---------- 表示 ---------- */
function render(list) {
  list.innerHTML = "";
  const div = document.getElementById("list");
  div.innerHTML = "";
  list.forEach(e => {
    const d = e.createdAt.toDate();
    div.innerHTML += `
      <div class="entry">
        <a href="${e.url}" target="_blank">${e.url}</a>
        <div>ジャンル：${e.genre}</div>
        <div>${e.memo}</div>
        <div class="small">${d.toLocaleString()}</div>
      </div>
    `;
  });
}
</script>
</body>
</html>

