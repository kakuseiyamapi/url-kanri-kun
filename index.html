<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>URLç®¡ç†ï¼†æ•´ç†ãã‚“</title>

<style>
body {
  font-family: sans-serif;
  background: #fff;
  margin: 20px;
}
input, textarea, button {
  width: 100%;
  margin: 5px 0;
  padding: 6px;
}
.entry {
  border: 1px solid #ccc;
  padding: 8px;
  margin-top: 8px;
}
.small {
  font-size: 12px;
  color: #555;
}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>

<body>

<h1>URLç®¡ç†ï¼†æ•´ç†ãã‚“</h1>

<button onclick="login()">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
<button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
<p id="user"></p>

<hr>

<h3>è¿½åŠ </h3>
<input id="url" placeholder="URL">
<input id="genre" placeholder="ã‚¸ãƒ£ãƒ³ãƒ«">
<textarea id="memo" placeholder="ãƒ¡ãƒ¢"></textarea>
<button onclick="addEntry()">è¿½åŠ </button>

<hr>

<h3>æ¤œç´¢</h3>
<input id="searchGenre" placeholder="ã‚¸ãƒ£ãƒ³ãƒ«ã§æ¤œç´¢">
<input id="searchDate" type="date">
<button onclick="search()">æ¤œç´¢</button>
<button onclick="clearSearch()">æ¤œç´¢ã‚¯ãƒªã‚¢</button>

<hr>

<div id="list"></div>

<script>
/* Firebaseè¨­å®š */
firebase.initializeApp({
  apiKey: "AIzaSyCRbxQK7LFzoEAeTYhFVrPEGCJx9QU7hAQ",
  authDomain: "url-kanri-kun.firebaseapp.com",
  projectId: "url-kanri-kun"
});

const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;
let cache = []; // ğŸ”¥ æ¤œç´¢ç”¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥

/* ãƒ­ã‚°ã‚¤ãƒ³ */
function login() {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider);
}

/* ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ */
function logout() {
  auth.signOut();
}

/* èªè¨¼ç›£è¦– */
auth.onAuthStateChanged(user => {
  if (user) {
    currentUser = user;
    document.getElementById("user").innerText =
      "ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š" + user.displayName;
    loadData();
  } else {
    currentUser = null;
    document.getElementById("user").innerText = "æœªãƒ­ã‚°ã‚¤ãƒ³";
    document.getElementById("list").innerHTML = "";
  }
});

/* è¿½åŠ  */
function addEntry() {
  if (!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦");

  const url = urlInput.value;
  if (!url) return;

  const now = new Date();

  db.collection("users")
    .doc(currentUser.uid)
    .collection("urls")
    .add({
      url,
      genre: genre.value,
      memo: memo.value,
      date: now.toISOString().slice(0,10),
      time: now.toLocaleTimeString(),
      created: now
    });

  urlInput.value = genre.value = memo.value = "";
}

/* èª­ã¿è¾¼ã¿ */
function loadData() {
  db.collection("users")
    .doc(currentUser.uid)
    .collection("urls")
    .orderBy("created", "desc")
    .onSnapshot(snapshot => {
      cache = [];
      snapshot.forEach(doc => {
        cache.push({ id: doc.id, ...doc.data() });
      });
      render(cache);
    });
}

/* æç”» */
function render(list) {
  const div = document.getElementById("list");
  div.innerHTML = "";
  list.forEach(e => {
    div.innerHTML += `
      <div class="entry">
        <a href="${e.url}" target="_blank">${e.url}</a>
        <div>ã‚¸ãƒ£ãƒ³ãƒ«ï¼š${e.genre}</div>
        <div>ãƒ¡ãƒ¢ï¼š${e.memo}</div>
        <div class="small">${e.date} ${e.time}</div>
        <button onclick="removeEntry('${e.id}')">å‰Šé™¤</button>
      </div>
    `;
  });
}

/* å‰Šé™¤ */
function removeEntry(id) {
  db.collection("users")
    .doc(currentUser.uid)
    .collection("urls")
    .doc(id)
    .delete();
}

/* æ¤œç´¢ */
function search() {
  const g = searchGenre.value;
  const d = searchDate.value;

  const filtered = cache.filter(e =>
    (!g || e.genre.includes(g)) &&
    (!d || e.date === d)
  );
  render(filtered);
}

/* æ¤œç´¢ã‚¯ãƒªã‚¢ */
function clearSearch() {
  searchGenre.value = "";
  searchDate.value = "";
  render(cache);
}
</script>

</body>
</html>
