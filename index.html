<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>URLç®¡ç†ï¼†æ•´ç†ãã‚“</title>

<style>
body {
  margin: 0;
  font-family: sans-serif;
  background: #bfe9ff;
}

.container {
  background: white;
  margin: 20px;
  padding: 20px;
  border-radius: 10px;
}

input, textarea, button {
  width: 100%;
  margin: 5px 0;
  padding: 8px;
}

.entry {
  border: 1px solid #ccc;
  padding: 10px;
  margin-top: 10px;
}

.small {
  font-size: 12px;
  color: #555;
}
</style>
</head>

<body>
<div class="container">

<h1>URLç®¡ç†ï¼†æ•´ç†ãã‚“</h1>
<p id="counter">èª­ã¿è¾¼ã¿ä¸­...</p>

<button onclick="login()">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
<button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
<p id="user"></p>

<hr>

<h3>è¿½åŠ </h3>
<input id="urlInput" placeholder="URL">
<input id="genreInput" placeholder="ã‚¸ãƒ£ãƒ³ãƒ«">
<textarea id="memoInput" placeholder="ãƒ¡ãƒ¢"></textarea>
<button onclick="addEntry()">è¿½åŠ </button>

<hr>

<h3>æ¤œç´¢</h3>
<input id="searchGenre" placeholder="ã‚¸ãƒ£ãƒ³ãƒ«æ¤œç´¢">
<input id="searchDate" type="date">
<button onclick="search()">æ¤œç´¢</button>
<button onclick="clearSearch()">ã‚¯ãƒªã‚¢</button>

<hr>

<div id="list"></div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCRbxQK7LFzoEAeTYhFVrPEGCJx9QU7hAQ",
  authDomain: "url-kanri-kun.firebaseapp.com",
  projectId: "url-kanri-kun"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
</script>

<script>
let currentUser = null;

/* ğŸ”¢ ãƒšãƒ¼ã‚¸é–‹ã„ãŸã‚‰1ã‚«ã‚¦ãƒ³ãƒˆ */
db.collection("counter").doc("access").set({
  count: firebase.firestore.FieldValue.increment(1)
}, { merge: true });

db.collection("counter").doc("access").get().then(d => {
  document.getElementById("counter").innerText =
    `ã‚ãªãŸã¯ ${d.data().count} äººç›®ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã™`;
});

function login() {
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
}

function logout() {
  auth.signOut();
}

auth.onAuthStateChanged(user => {
  currentUser = user;
  document.getElementById("user").innerText =
    user ? `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${user.displayName}` : "";
  if (user) loadEntries();
});

/* â• è¿½åŠ ï¼ˆã“ã“ãŒä»Šå›ã®æœ¬å‘½ä¿®æ­£ï¼‰ */
function addEntry() {
  if (!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");

  const urlValue = document.getElementById("urlInput").value;
  const genreValue = document.getElementById("genreInput").value;
  const memoValue = document.getElementById("memoInput").value;

  if (!urlValue) return;

  db.collection("users")
    .doc(currentUser.uid)
    .collection("urls")
    .add({
      url: urlValue,
      genre: genreValue,
      memo: memoValue,
      date: new Date().toISOString().slice(0,10),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

  document.getElementById("urlInput").value = "";
  document.getElementById("genreInput").value = "";
  document.getElementById("memoInput").value = "";
}

/* ğŸ“„ èª­ã¿è¾¼ã¿ */
function loadEntries() {
  db.collection("users")
    .doc(currentUser.uid)
    .collection("urls")
    .orderBy("createdAt", "desc")
    .onSnapshot(snap => {
      const list = document.getElementById("list");
      list.innerHTML = "";
      snap.forEach(doc => {
        const e = doc.data();
        list.innerHTML += `
          <div class="entry">
            <a href="${e.url}" target="_blank">${e.url}</a>
            <div>ã‚¸ãƒ£ãƒ³ãƒ«ï¼š${e.genre}</div>
            <div>ãƒ¡ãƒ¢ï¼š${e.memo}</div>
            <div class="small">${e.date}</div>
          </div>
        `;
      });
    });
}

/* ğŸ” æ¤œç´¢ */
function search() {
  const g = document.getElementById("searchGenre").value;
  const d = document.getElementById("searchDate").value;

  db.collection("users")
    .doc(currentUser.uid)
    .collection("urls")
    .get()
    .then(snap => {
      const list = document.getElementById("list");
      list.innerHTML = "";
      snap.forEach(doc => {
        const e = doc.data();
        if (
          (!g || e.genre.includes(g)) &&
          (!d || e.date === d)
        ) {
          list.innerHTML += `
            <div class="entry">
              <a href="${e.url}" target="_blank">${e.url}</a>
              <div>ã‚¸ãƒ£ãƒ³ãƒ«ï¼š${e.genre}</div>
              <div>ãƒ¡ãƒ¢ï¼š${e.memo}</div>
              <div class="small">${e.date}</div>
            </div>
          `;
        }
      });
    });
}

function clearSearch() {
  loadEntries();
}
</script>
</body>
</html>
